# Backend Integration Test Execution
# Runs Spring Boot integration tests with Testcontainers

parameters:
  - name: workingDirectory
    type: string
    default: 'backend'
  - name: testResultsPattern
    type: string
    default: '**/TEST-*.xml'

steps:
  - checkout: self
    fetchDepth: 1

  - task: JavaToolInstaller@0
    displayName: 'Install Java 21'
    inputs:
      versionSpec: '21'
      jdkArchitecture: 'x64'
      jdkSource: 'PreInstalled'

  - task: Cache@2
    displayName: 'Cache Gradle Dependencies'
    inputs:
      key: 'gradle | "$(Agent.OS)" | ${{ parameters.workingDirectory }}/build.gradle'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '${{ parameters.workingDirectory }}/.gradle'

  - script: |
      cd ${{ parameters.workingDirectory }}
      ./gradlew clean test --tests "*IntegrationTest" --tests "*RepositoryTest" --tests "*ApiTest"
    displayName: 'Run Backend Integration Tests'
    continueOnError: false

  - task: PublishTestResults@2
    displayName: 'Publish Integration Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '${{ parameters.workingDirectory }}/${{ parameters.testResultsPattern }}'
      testRunTitle: 'Backend Integration Tests - $(Build.BuildNumber)'
      mergeTestResults: true
      failTaskOnFailedTests: true

  - script: |
      echo "##vso[task.setvariable variable=BackendIntegrationTestStatus]success"
    displayName: 'Set Test Status'
    condition: succeeded()

  - script: |
      echo "##vso[task.setvariable variable=BackendIntegrationTestStatus]failed"
      exit 1
    displayName: 'Set Test Status (Failed)'
    condition: failed()

