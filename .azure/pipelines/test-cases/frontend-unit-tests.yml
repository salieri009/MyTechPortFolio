# Frontend Unit Test Execution
# Runs frontend unit tests with coverage reporting

parameters:
  - name: workingDirectory
    type: string
    default: 'frontend'
  - name: testResultsPattern
    type: string
    default: '**/test-results.xml'
  - name: coverageReportPattern
    type: string
    default: '**/coverage/**'

steps:
  - checkout: self
    fetchDepth: 1

  - task: NodeTool@0
    displayName: 'Install Node.js 18'
    inputs:
      versionSpec: '18.x'

  - task: Cache@2
    displayName: 'Cache npm Dependencies'
    inputs:
      key: 'npm | "$(Agent.OS)" | ${{ parameters.workingDirectory }}/package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
      path: '${{ parameters.workingDirectory }}/node_modules'

  - script: |
      cd ${{ parameters.workingDirectory }}
      npm ci
    displayName: 'Install Dependencies'

  - script: |
      cd ${{ parameters.workingDirectory }}
      npm run lint
    displayName: 'Run ESLint'
    continueOnError: false

  - script: |
      cd ${{ parameters.workingDirectory }}
      # Run tests if test script exists
      if grep -q '"test"' package.json; then
        npm run test -- --coverage --reporter=junit --outputFile=test-results.xml || true
      else
        echo "No test script found in package.json"
      fi
    displayName: 'Run Frontend Unit Tests'
    continueOnError: false

  - task: PublishTestResults@2
    displayName: 'Publish Unit Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '${{ parameters.workingDirectory }}/${{ parameters.testResultsPattern }}'
      testRunTitle: 'Frontend Unit Tests - $(Build.BuildNumber)'
      mergeTestResults: true
      failTaskOnFailedTests: false

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish Code Coverage Report'
    condition: and(always(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      codeCoverageTool: 'Cobertura'
      summaryFileLocation: '${{ parameters.workingDirectory }}/coverage/cobertura-coverage.xml'
      reportDirectory: '${{ parameters.workingDirectory }}/coverage'
      failIfCoverageEmpty: false

  - script: |
      echo "##vso[task.setvariable variable=FrontendUnitTestStatus]success"
    displayName: 'Set Test Status'
    condition: succeeded()

  - script: |
      echo "##vso[task.setvariable variable=FrontendUnitTestStatus]failed"
      exit 1
    displayName: 'Set Test Status (Failed)'
    condition: failed()

