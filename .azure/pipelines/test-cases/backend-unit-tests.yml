# Backend Unit Test Execution
# Runs Gradle unit tests with coverage reporting

parameters:
  - name: workingDirectory
    type: string
    default: 'backend'
  - name: testResultsPattern
    type: string
    default: '**/TEST-*.xml'
  - name: coverageReportPattern
    type: string
    default: '**/build/reports/jacoco/test/html/index.html'

steps:
  - checkout: self
    fetchDepth: 1

  - task: JavaToolInstaller@0
    displayName: 'Install Java 21'
    inputs:
      versionSpec: '21'
      jdkArchitecture: 'x64'
      jdkSource: 'PreInstalled'

  - task: Cache@2
    displayName: 'Cache Gradle Dependencies'
    inputs:
      key: 'gradle | "$(Agent.OS)" | ${{ parameters.workingDirectory }}/build.gradle'
      restoreKeys: |
        gradle | "$(Agent.OS)"
      path: '${{ parameters.workingDirectory }}/.gradle'

  - task: Gradle@3
    displayName: 'Run Backend Unit Tests'
    inputs:
      workingDirectory: ${{ parameters.workingDirectory }}
      gradleWrapperFile: '${{ parameters.workingDirectory }}/gradlew'
      gradleOptions: '-Xmx3072m -Dorg.gradle.daemon=false'
      tasks: 'clean test'
      publishJUnitResults: true
      testResultsFiles: '${{ parameters.testResultsPattern }}'
      codeCoverageToolOption: 'JaCoCo'
      codeCoverageClassFiles: '**/build/classes/java/main/**/*.class'
      codeCoverageSourceFiles: '**/src/main/java/**/*.java'
      codeCoverageFailIfEmpty: false

  - task: PublishTestResults@2
    displayName: 'Publish Unit Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '${{ parameters.workingDirectory }}/${{ parameters.testResultsPattern }}'
      testRunTitle: 'Backend Unit Tests - $(Build.BuildNumber)'
      mergeTestResults: true
      failTaskOnFailedTests: true

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish Code Coverage Report'
    condition: and(always(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      codeCoverageTool: 'JaCoCo'
      summaryFileLocation: '${{ parameters.workingDirectory }}/build/reports/jacoco/test/jacocoTestReport.xml'
      reportDirectory: '${{ parameters.workingDirectory }}/build/reports/jacoco/test/html'
      failIfCoverageEmpty: false

  - script: |
      echo "##vso[task.setvariable variable=BackendUnitTestStatus]success"
    displayName: 'Set Test Status'
    condition: succeeded()

  - script: |
      echo "##vso[task.setvariable variable=BackendUnitTestStatus]failed"
      exit 1
    displayName: 'Set Test Status (Failed)'
    condition: failed()

