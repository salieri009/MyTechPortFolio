# Security Test Execution
# Runs security-focused tests (OWASP ZAP, dependency scanning)

parameters:
  - name: backendUrl
    type: string
    default: 'http://localhost:8080'
  - name: frontendUrl
    type: string
    default: 'http://localhost:5173'

steps:
  - checkout: self
    fetchDepth: 1

  - task: NodeTool@0
    displayName: 'Install Node.js 18'
    inputs:
      versionSpec: '18.x'

  # OWASP ZAP API Security Testing
  - script: |
      echo "Installing OWASP ZAP..."
      wget -q https://github.com/zaproxy/zaproxy/releases/latest/download/ZAP_2.14.0_Linux.tar.gz -O /tmp/zap.tar.gz
      tar -xzf /tmp/zap.tar.gz -C /tmp
      chmod +x /tmp/ZAP_*/zap.sh
    displayName: 'Install OWASP ZAP'
    continueOnError: true

  - script: |
      if [ -f "/tmp/ZAP_*/zap.sh" ]; then
        echo "Running OWASP ZAP baseline scan on ${{ parameters.backendUrl }}"
        /tmp/ZAP_*/zap-baseline.py -t "${{ parameters.backendUrl }}/api/v1" -J zap-report.json || true
      else
        echo "OWASP ZAP not available. Skipping API security scan."
      fi
    displayName: 'Run OWASP ZAP Security Scan'
    continueOnError: true

  # Dependency vulnerability scanning
  - script: |
      cd backend
      ./gradlew dependencies > dependencies.txt || true
      echo "Backend dependencies listed"
    displayName: 'List Backend Dependencies'
    continueOnError: true

  - script: |
      cd frontend
      npm audit --audit-level=high --json > npm-audit.json || true
      echo "Frontend dependency audit completed"
    displayName: 'Frontend Dependency Audit'
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Security Test Reports'
    condition: always()
    inputs:
      pathToPublish: '$(Pipeline.Workspace)'
      artifactName: 'security-test-reports'
      publishLocation: 'Container'

  - script: |
      echo "##vso[task.setvariable variable=SecurityTestStatus]success"
    displayName: 'Set Test Status'
    condition: succeeded()

  - script: |
      echo "##vso[task.setvariable variable=SecurityTestStatus]failed"
    displayName: 'Set Test Status (Failed)'
    condition: failed()

