# Performance Test Execution
# Runs performance and load tests

parameters:
  - name: backendUrl
    type: string
    default: 'http://localhost:8080'
  - name: frontendUrl
    type: string
    default: 'http://localhost:5173'
  - name: loadTestDuration
    type: string
    default: '60s'
  - name: concurrentUsers
    type: string
    default: '10'

steps:
  - checkout: self
    fetchDepth: 1

  - task: NodeTool@0
    displayName: 'Install Node.js 18'
    inputs:
      versionSpec: '18.x'

  # Install k6 for load testing
  - script: |
      echo "Installing k6 load testing tool..."
      sudo gpg -k
      sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D9
      echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
      sudo apt-get update
      sudo apt-get install k6 -y
    displayName: 'Install k6 Load Testing Tool'
    continueOnError: true

  # Create basic k6 test script
  - script: |
      mkdir -p performance-tests
      cat > performance-tests/load-test.js << 'EOF'
      import http from 'k6/http';
      import { check, sleep } from 'k6';

      export const options = {
        stages: [
          { duration: '10s', target: 5 },
          { duration: '30s', target: 10 },
          { duration: '20s', target: 0 },
        ],
        thresholds: {
          http_req_duration: ['p(95)<500'],
          http_req_failed: ['rate<0.01'],
        },
      };

      export default function () {
        const baseUrl = '${{ parameters.backendUrl }}';
        
        // Test projects endpoint
        const projectsRes = http.get(`${baseUrl}/api/v1/projects?page=1&size=10`);
        check(projectsRes, {
          'projects status is 200': (r) => r.status === 200,
          'projects response time < 500ms': (r) => r.timings.duration < 500,
        });
        
        sleep(1);
      }
      EOF
      echo "k6 test script created"
    displayName: 'Create Load Test Script'
    continueOnError: true

  - script: |
      if command -v k6 &> /dev/null; then
        echo "Running k6 load tests..."
        k6 run performance-tests/load-test.js --out json=performance-results.json || true
      else
        echo "k6 not available. Skipping load tests."
      fi
    displayName: 'Run Load Tests'
    continueOnError: true

  # Basic performance checks
  - script: |
      echo "Running basic performance checks..."
      
      # Test response time
      START_TIME=$(date +%s%N)
      curl -s -o /dev/null -w "%{http_code}" "${{ parameters.backendUrl }}/api/v1/projects?page=1&size=1"
      END_TIME=$(date +%s%N)
      DURATION=$((($END_TIME - $START_TIME) / 1000000))
      
      echo "Response time: ${DURATION}ms"
      
      if [ $DURATION -gt 1000 ]; then
        echo "Warning: Response time exceeds 1 second"
      fi
    displayName: 'Basic Performance Checks'
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Performance Test Results'
    condition: always()
    inputs:
      pathToPublish: 'performance-tests'
      artifactName: 'performance-test-results'
      publishLocation: 'Container'

  - script: |
      echo "##vso[task.setvariable variable=PerformanceTestStatus]success"
    displayName: 'Set Test Status'
    condition: succeeded()

  - script: |
      echo "##vso[task.setvariable variable=PerformanceTestStatus]failed"
    displayName: 'Set Test Status (Failed)'
    condition: failed()

