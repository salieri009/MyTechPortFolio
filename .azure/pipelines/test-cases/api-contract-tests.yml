# API Contract Test Execution
# Validates API contracts between frontend and backend

parameters:
  - name: backendUrl
    type: string
    default: 'http://localhost:8080'
  - name: apiVersion
    type: string
    default: 'v1'

steps:
  - checkout: self
    fetchDepth: 1

  - task: NodeTool@0
    displayName: 'Install Node.js 18'
    inputs:
      versionSpec: '18.x'

  - script: |
      # Install API testing tools if needed
      npm install -g newman || true
    displayName: 'Install API Testing Tools'

  - script: |
      echo "Running API contract tests against ${{ parameters.backendUrl }}/api/${{ parameters.apiVersion }}"
      
      # Basic API contract validation
      # Test 1: Projects endpoint
      curl -f "${{ parameters.backendUrl }}/api/${{ parameters.apiVersion }}/projects?page=1&size=1" \
        -H "Content-Type: application/json" \
        -o /dev/null -w "%{http_code}" || exit 1
      
      # Test 2: Academics endpoint
      curl -f "${{ parameters.backendUrl }}/api/${{ parameters.apiVersion }}/academics" \
        -H "Content-Type: application/json" \
        -o /dev/null -w "%{http_code}" || exit 1
      
      # Test 3: Testimonials endpoint
      curl -f "${{ parameters.backendUrl }}/api/${{ parameters.apiVersion }}/testimonials" \
        -H "Content-Type: application/json" \
        -o /dev/null -w "%{http_code}" || exit 1
      
      echo "API contract tests passed"
    displayName: 'Run API Contract Tests'
    continueOnError: false

  - script: |
      echo "##vso[task.setvariable variable=ApiContractTestStatus]success"
    displayName: 'Set Test Status'
    condition: succeeded()

  - script: |
      echo "##vso[task.setvariable variable=ApiContractTestStatus]failed"
      exit 1
    displayName: 'Set Test Status (Failed)'
    condition: failed()

