# Frontend Integration Test Execution
# Runs frontend integration tests with MSW (Mock Service Worker)

parameters:
  - name: workingDirectory
    type: string
    default: 'frontend'
  - name: testResultsPattern
    type: string
    default: '**/test-results.xml'

steps:
  - checkout: self
    fetchDepth: 1

  - task: NodeTool@0
    displayName: 'Install Node.js 18'
    inputs:
      versionSpec: '18.x'

  - task: Cache@2
    displayName: 'Cache npm Dependencies'
    inputs:
      key: 'npm | "$(Agent.OS)" | ${{ parameters.workingDirectory }}/package-lock.json'
      restoreKeys: |
        npm | "$(Agent.OS)"
      path: '${{ parameters.workingDirectory }}/node_modules'

  - script: |
      cd ${{ parameters.workingDirectory }}
      npm ci
    displayName: 'Install Dependencies'

  - script: |
      cd ${{ parameters.workingDirectory }}
      # Run integration tests if test:integration script exists
      if grep -q '"test:integration"' package.json; then
        npm run test:integration -- --reporter=junit --outputFile=test-results.xml || true
      else
        echo "No integration test script found in package.json"
        echo "Skipping integration tests"
      fi
    displayName: 'Run Frontend Integration Tests'
    continueOnError: false

  - task: PublishTestResults@2
    displayName: 'Publish Integration Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '${{ parameters.workingDirectory }}/${{ parameters.testResultsPattern }}'
      testRunTitle: 'Frontend Integration Tests - $(Build.BuildNumber)'
      mergeTestResults: true
      failTaskOnFailedTests: false

  - script: |
      echo "##vso[task.setvariable variable=FrontendIntegrationTestStatus]success"
    displayName: 'Set Test Status'
    condition: succeeded()

  - script: |
      echo "##vso[task.setvariable variable=FrontendIntegrationTestStatus]failed"
      exit 1
    displayName: 'Set Test Status (Failed)'
    condition: failed()

