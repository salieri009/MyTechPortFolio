# Monitoring and Alerting Template
# Configures monitoring and sends alerts based on pipeline status

parameters:
  - name: pipelineStatus
    type: string
    values:
      - 'success'
      - 'failure'
      - 'cancelled'
  - name: environment
    type: string
    default: ''
  - name: deploymentUrl
    type: string
    default: ''

steps:
  - script: |
      echo "Pipeline Status: ${{ parameters.pipelineStatus }}"
      echo "Environment: ${{ parameters.environment }}"
      echo "Deployment URL: ${{ parameters.deploymentUrl }}"
      
      # Log pipeline metrics
      echo "##vso[task.logissue type=warning]Pipeline ${{ parameters.pipelineStatus }} for ${{ parameters.environment }}"
      
      # Send to Application Insights or Log Analytics
      # Example: curl -X POST "https://api.applicationinsights.io/v1/apps/$(APP_INSIGHTS_APP_ID)/events" \
      #   -H "x-api-key: $(APP_INSIGHTS_API_KEY)" \
      #   -d '{"name": "PipelineEvent", "properties": {"status": "${{ parameters.pipelineStatus }}", "environment": "${{ parameters.environment }}"}}'
    displayName: 'Log Pipeline Metrics'
    condition: always()

  # Send notification via template
  - template: notify.yml
    parameters:
      status: ${{ parameters.pipelineStatus }}
      environment: ${{ parameters.environment }}
      message: "Pipeline ${{ parameters.pipelineStatus }} for ${{ parameters.environment }} environment"

  # Publish deployment status
  - task: PublishPipelineArtifact@1
    displayName: 'Publish Deployment Status'
    condition: always()
    inputs:
      targetPath: '$(Pipeline.Workspace)'
      artifactName: 'deployment-status-${{ parameters.environment }}'
      publishLocation: 'pipeline'

