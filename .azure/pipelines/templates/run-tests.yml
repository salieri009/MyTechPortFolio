# Reusable Test Execution Template
# Executes tests and publishes results

parameters:
  - name: testType
    type: string
    values:
      - 'unit'
      - 'integration'
      - 'e2e'
  - name: workingDirectory
    type: string
  - name: testCommand
    type: string
  - name: testResultsPattern
    type: string
    default: '**/test-results.xml'
  - name: coverageReportPattern
    type: string
    default: '**/coverage/**'

steps:
  - checkout: self
    fetchDepth: 1

  - script: |
      cd ${{ parameters.workingDirectory }}
      ${{ parameters.testCommand }}
    displayName: 'Run ${{ parameters.testType }} Tests'
    continueOnError: false

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: '${{ parameters.workingDirectory }}/${{ parameters.testResultsPattern }}'
      testRunTitle: '${{ parameters.testType }} Tests - $(Build.BuildNumber)'
      mergeTestResults: true
      failTaskOnFailedTests: false

  - task: PublishCodeCoverageResults@1
    displayName: 'Publish Code Coverage'
    condition: and(always(), ne(variables['Build.Reason'], 'PullRequest'))
    inputs:
      codeCoverageTool: 'JaCoCo'
      summaryFileLocation: '${{ parameters.workingDirectory }}/${{ parameters.coverageReportPattern }}'
      reportDirectory: '${{ parameters.workingDirectory }}/${{ parameters.coverageReportPattern }}'
      failIfCoverageEmpty: false

