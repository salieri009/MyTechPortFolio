# Security Scanning Template
# Performs container and dependency vulnerability scanning

parameters:
  - name: backendImage
    type: string
  - name: frontendImage
    type: string
  - name: containerRegistry
    type: string

steps:
  - checkout: self
    fetchDepth: 1

  # Install Trivy
  - script: |
      sudo apt-get update
      sudo apt-get install wget apt-transport-https gnupg lsb-release -y
      wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
      echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
      sudo apt-get update
      sudo apt-get install trivy -y
    displayName: 'Install Trivy Scanner'

  # Scan backend image
  - script: |
      trivy image --exit-code 0 --severity HIGH,CRITICAL --format sarif --output backend-scan.sarif ${{ parameters.backendImage }}
    displayName: 'Scan Backend Container Image'
    continueOnError: true

  # Scan frontend image
  - script: |
      trivy image --exit-code 0 --severity HIGH,CRITICAL --format sarif --output frontend-scan.sarif ${{ parameters.frontendImage }}
    displayName: 'Scan Frontend Container Image'
    continueOnError: true

  # Publish security scan results
  - task: PublishSecurityAnalysisLogs@3
    displayName: 'Publish Security Scan Results'
    condition: always()
    inputs:
      Artifacts: 'backend-scan.sarif,frontend-scan.sarif'
      Category: 'Container Security'

  # Dependency scanning (Backend - Gradle)
  - task: Gradle@3
    displayName: 'Backend Dependency Check'
    inputs:
      workingDirectory: 'backend'
      gradleWrapperFile: 'backend/gradlew'
      tasks: 'dependencies'
    continueOnError: true

  # Dependency scanning (Frontend - npm audit)
  - task: NodeTool@0
    displayName: 'Setup Node.js'
    inputs:
      versionSpec: '18.x'

  - script: |
      cd frontend
      npm audit --audit-level=high --json > npm-audit.json || true
    displayName: 'Frontend Dependency Audit'
    continueOnError: true

  # Snyk dependency scanning (if SNYK_TOKEN is configured)
  - script: |
      if [ -n "$(SNYK_TOKEN)" ] && [ "$(SNYK_TOKEN)" != "" ]; then
        echo "Installing Snyk CLI..."
        npm install -g snyk || true
        
        # Backend dependency scan (if Gradle project)
        if [ -f "backend/build.gradle" ]; then
          cd backend
          snyk test --json > ../snyk-backend-results.json || true
          cd ..
        fi
        
        # Frontend dependency scan
        if [ -f "frontend/package.json" ]; then
          cd frontend
          snyk test --json > ../snyk-frontend-results.json || true
          cd ..
        fi
      else
        echo "Snyk token not configured. Skipping Snyk scans."
      fi
    displayName: 'Snyk Dependency Scanning'
    continueOnError: true
    env:
      SNYK_TOKEN: $(SNYK_TOKEN)

  # Generate SBOM (Software Bill of Materials)
  - script: |
      echo "Generating SBOM..."
      
      # Backend SBOM (Gradle dependencies)
      if [ -f "backend/build.gradle" ]; then
        cd backend
        ./gradlew dependencies --configuration runtimeClasspath > ../backend-sbom.txt || true
        cd ..
      fi
      
      # Frontend SBOM (npm dependencies)
      if [ -f "frontend/package.json" ]; then
        cd frontend
        npm list --json > ../frontend-sbom.json || true
        cd ..
      fi
      
      echo "SBOM generation completed"
    displayName: 'Generate SBOM'
    continueOnError: true

  # License compliance checking
  - script: |
      echo "Checking license compliance..."
      
      # Backend license check (Gradle)
      if [ -f "backend/build.gradle" ]; then
        cd backend
        ./gradlew licenseReport 2>/dev/null || echo "License report not available (install license-gradle-plugin to enable)"
        cd ..
      fi
      
      # Frontend license check (npm)
      if [ -f "frontend/package.json" ]; then
        cd frontend
        npm install -g license-checker 2>/dev/null || true
        license-checker --json > ../frontend-licenses.json 2>/dev/null || echo "License checker not available"
        cd ..
      fi
      
      echo "License compliance check completed"
    displayName: 'License Compliance Check'
    continueOnError: true

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Security Reports'
    condition: always()
    inputs:
      pathToPublish: '$(Pipeline.Workspace)'
      artifactName: 'security-reports'
      publishLocation: 'Container'

