# Reusable Docker Build Template
# Builds and pushes Docker images to Azure Container Registry

parameters:
  - name: workingDirectory
    type: string
  - name: dockerfilePath
    type: string
  - name: imageName
    type: string
  - name: containerRegistry
    type: string
  - name: tags
    type: object
    default: []
  - name: buildArgs
    type: object
    default: {}

steps:
  - checkout: self
    fetchDepth: 1

  # Prepare build arguments if provided
  - script: |
      BUILD_ARGS=""
      ${{ each key, value in parameters.buildArgs }}
      BUILD_ARGS="${BUILD_ARGS} --build-arg ${{ key }}=${{ value }}"
      ${{ end }}
      echo "##vso[task.setvariable variable=BuildArguments]$BUILD_ARGS"
    displayName: 'Prepare Build Arguments'
    condition: ne(length(parameters.buildArgs), 0)
    continueOnError: false

  - task: Docker@2
    displayName: 'Build and Push ${{ parameters.imageName }}'
    inputs:
      containerRegistry: ${{ parameters.containerRegistry }}
      repository: ${{ parameters.imageName }}
      command: 'buildAndPush'
      Dockerfile: ${{ parameters.dockerfilePath }}
      tags: |
        ${{ each tag in parameters.tags }}
        ${{ tag }}
        ${{ end }}
      buildContext: ${{ parameters.workingDirectory }}
      ${{ if ne(length(parameters.buildArgs), 0) }}:
        arguments: '$(BuildArguments)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Build Artifacts'
    inputs:
      pathToPublish: '$(Pipeline.Workspace)'
      artifactName: '${{ parameters.imageName }}-artifacts'
      publishLocation: 'Container'

