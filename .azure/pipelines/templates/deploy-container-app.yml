# Reusable Container App Deployment Template
# Deploys containerized applications to Azure Container Apps

parameters:
  - name: environment
    type: string
  - name: backendAppName
    type: string
  - name: frontendAppName
    type: string
  - name: containerRegistry
    type: string
  - name: backendImage
    type: string
  - name: frontendImage
    type: string
  - name: resourceGroup
    type: string
  - name: containerAppEnv
    type: string

steps:
  - checkout: self
    fetchDepth: 1

  # Save current image tags for rollback
  - task: AzureCLI@2
    displayName: 'Save Current Image Tags for Rollback'
    inputs:
      azureSubscription: 'Azure_Subscription_Connection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        # Get current backend image
        CURRENT_BACKEND_IMAGE=$(az containerapp show \
          --name ${{ parameters.backendAppName }} \
          --resource-group ${{ parameters.resourceGroup }} \
          --query "properties.template.containers[0].image" \
          --output tsv)
        
        # Get current frontend image
        CURRENT_FRONTEND_IMAGE=$(az containerapp show \
          --name ${{ parameters.frontendAppName }} \
          --resource-group ${{ parameters.resourceGroup }} \
          --query "properties.template.containers[0].image" \
          --output tsv)
        
        echo "##vso[task.setvariable variable=PreviousBackendImage]$CURRENT_BACKEND_IMAGE"
        echo "##vso[task.setvariable variable=PreviousFrontendImage]$CURRENT_FRONTEND_IMAGE"
        
        echo "Saved rollback images:"
        echo "Backend: $CURRENT_BACKEND_IMAGE"
        echo "Frontend: $CURRENT_FRONTEND_IMAGE"

  - task: AzureCLI@2
    displayName: 'Deploy Backend Container App'
    inputs:
      azureSubscription: 'Azure_Subscription_Connection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Deploying backend to ${{ parameters.environment }} environment"
        
        # Update backend container app
        az containerapp update \
          --name ${{ parameters.backendAppName }} \
          --resource-group ${{ parameters.resourceGroup }} \
          --image ${{ parameters.backendImage }} \
          --registry-server $(ACR_NAME).azurecr.io \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv
        
        echo "Backend deployment completed"

  - task: AzureCLI@2
    displayName: 'Deploy Frontend Container App'
    inputs:
      azureSubscription: 'Azure_Subscription_Connection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Deploying frontend to ${{ parameters.environment }} environment"
        
        # Update frontend container app
        az containerapp update \
          --name ${{ parameters.frontendAppName }} \
          --resource-group ${{ parameters.resourceGroup }} \
          --image ${{ parameters.frontendImage }} \
          --registry-server $(ACR_NAME).azurecr.io \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv
        
        echo "Frontend deployment completed"

  - task: AzureCLI@2
    displayName: 'Health Check Validation'
    inputs:
      azureSubscription: 'Azure_Subscription_Connection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Performing health checks..."
        
        # Get backend URL
        BACKEND_URL=$(az containerapp show \
          --name ${{ parameters.backendAppName }} \
          --resource-group ${{ parameters.resourceGroup }} \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv)
        
        # Health check with retry
        MAX_RETRIES=5
        RETRY_COUNT=0
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          if curl -f "https://$BACKEND_URL/api/actuator/health"; then
            echo "Backend health check passed"
            break
          else
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check failed, retrying... ($RETRY_COUNT/$MAX_RETRIES)"
            sleep 10
          fi
        done
        
        if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
          echo "Health check failed after $MAX_RETRIES attempts"
          exit 1
        fi

  - task: AzureCLI@2
    displayName: 'Smoke Tests'
    condition: and(succeeded(), eq('${{ parameters.environment }}', 'production'))
    inputs:
      azureSubscription: 'Azure_Subscription_Connection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Running smoke tests..."
        
        # Get URLs
        BACKEND_URL=$(az containerapp show \
          --name ${{ parameters.backendAppName }} \
          --resource-group ${{ parameters.resourceGroup }} \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv)
        
        FRONTEND_URL=$(az containerapp show \
          --name ${{ parameters.frontendAppName }} \
          --resource-group ${{ parameters.resourceGroup }} \
          --query "properties.configuration.ingress.fqdn" \
          --output tsv)
        
        # Basic smoke tests
        curl -f "https://$BACKEND_URL/api/v1/projects?page=1&size=1" || exit 1
        curl -f "https://$FRONTEND_URL" || exit 1
        
        echo "Smoke tests passed"

  # Send deployment success notification
  - template: ../templates/monitoring-alerts.yml
    parameters:
      pipelineStatus: 'success'
      environment: ${{ parameters.environment }}
      deploymentUrl: 'https://$(az containerapp show --name ${{ parameters.frontendAppName }} --resource-group ${{ parameters.resourceGroup }} --query "properties.configuration.ingress.fqdn" --output tsv)'

  # Rollback on failure
  - task: AzureCLI@2
    displayName: 'Rollback on Failure'
    condition: failed()
    inputs:
      azureSubscription: 'Azure_Subscription_Connection'
      scriptType: 'bash'
      scriptLocation: 'inlineScript'
      inlineScript: |
        echo "Deployment failed. Initiating rollback..."
        
        # Rollback backend if previous image exists
        if [ -n "$(PreviousBackendImage)" ]; then
          echo "Rolling back backend to $(PreviousBackendImage)"
          az containerapp update \
            --name ${{ parameters.backendAppName }} \
            --resource-group ${{ parameters.resourceGroup }} \
            --image $(PreviousBackendImage) \
            --registry-server $(ACR_NAME).azurecr.io || echo "Backend rollback failed"
        fi
        
        # Rollback frontend if previous image exists
        if [ -n "$(PreviousFrontendImage)" ]; then
          echo "Rolling back frontend to $(PreviousFrontendImage)"
          az containerapp update \
            --name ${{ parameters.frontendAppName }} \
            --resource-group ${{ parameters.resourceGroup }} \
            --image $(PreviousFrontendImage) \
            --registry-server $(ACR_NAME).azurecr.io || echo "Frontend rollback failed"
        fi
        
        echo "Rollback completed"
        exit 1

