# Notification Template
# Sends notifications on pipeline events (Slack/Teams/Email)
# Supports multiple notification channels via webhooks

parameters:
  - name: status
    type: string
    values:
      - 'success'
      - 'failure'
      - 'cancelled'
  - name: environment
    type: string
    default: ''
  - name: message
    type: string
    default: ''

steps:
  - script: |
      echo "Pipeline Status: ${{ parameters.status }}"
      echo "Environment: ${{ parameters.environment }}"
      echo "Message: ${{ parameters.message }}"
      
      STATUS="${{ parameters.status }}"
      ENV="${{ parameters.environment }}"
      MSG="${{ parameters.message }}"
      BUILD_URL="$(System.CollectionUri)$(System.TeamProject)/_build/results?buildId=$(Build.BuildId)"
      BRANCH="$(Build.SourceBranchName)"
      COMMIT="$(Build.SourceVersion)"
      
      # Determine color/emoji based on status
      if [ "$STATUS" = "success" ]; then
        COLOR="#28a745"
        EMOJI="✅"
      elif [ "$STATUS" = "failure" ]; then
        COLOR="#dc3545"
        EMOJI="❌"
      else
        COLOR="#6c757d"
        EMOJI="⚠️"
      fi
      
      # Slack notification
      if [ -n "$(SLACK_WEBHOOK_URL)" ] && [ "$(SLACK_WEBHOOK_URL)" != "" ]; then
        PAYLOAD=$(cat <<EOF
      {
        "attachments": [{
          "color": "$COLOR",
          "title": "$EMOJI Pipeline $STATUS",
          "text": "$MSG",
          "fields": [
            {"title": "Environment", "value": "$ENV", "short": true},
            {"title": "Branch", "value": "$BRANCH", "short": true},
            {"title": "Build", "value": "<$BUILD_URL|View Build>", "short": false}
          ],
          "footer": "MyPortFolio CI/CD",
          "ts": $(date +%s)
        }]
      }
      EOF
        )
        curl -X POST -H 'Content-type: application/json' \
          --data "$PAYLOAD" \
          "$(SLACK_WEBHOOK_URL)" || echo "Slack notification failed"
      fi
      
      # Microsoft Teams notification
      if [ -n "$(TEAMS_WEBHOOK_URL)" ] && [ "$(TEAMS_WEBHOOK_URL)" != "" ]; then
        PAYLOAD=$(cat <<EOF
      {
        "@type": "MessageCard",
        "@context": "https://schema.org/extensions",
        "themeColor": "$COLOR",
        "summary": "Pipeline $STATUS",
        "sections": [{
          "activityTitle": "$EMOJI Pipeline $STATUS",
          "activitySubtitle": "$MSG",
          "facts": [
            {"name": "Environment", "value": "$ENV"},
            {"name": "Branch", "value": "$BRANCH"},
            {"name": "Status", "value": "$STATUS"}
          ],
          "markdown": true
        }],
        "potentialAction": [{
          "@type": "OpenUri",
          "name": "View Build",
          "targets": [{"os": "default", "uri": "$BUILD_URL"}]
        }]
      }
      EOF
        )
        curl -X POST -H 'Content-type: application/json' \
          --data "$PAYLOAD" \
          "$(TEAMS_WEBHOOK_URL)" || echo "Teams notification failed"
      fi
      
      echo "Notifications sent"
    displayName: 'Send Notification'
    condition: always()
    env:
      SLACK_WEBHOOK_URL: $(SLACK_WEBHOOK_URL)
      TEAMS_WEBHOOK_URL: $(TEAMS_WEBHOOK_URL)

